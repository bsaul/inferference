<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>`inferference` Vignette ‚Ä¢ inferference</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="`inferference` Vignette">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">inferference</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/inferference_intro.html">`inferference` Vignette</a>
    </li>
    <li>
      <a href="../articles/inferference_plots.html">Plotting Causal Effects with `inferference`</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>
<code>inferference</code> Vignette</h1>
                        <h4 data-toc-skip class="author">Bradley
Saul</h4>
            <address class="author_afil">
      University of North
Carolina<br><h4 data-toc-skip class="author">Michael
Hudgens</h4>
            <address class="author_afil">
      University of North Carolina<br><h4 data-toc-skip class="date">2025-05-14</h4>
      

      <div class="hidden name"><code>inferference_intro.Rmd</code></div>

    </address>
</address>
</div>

    
    
<div class="section level2">
<h2 id="jss-article">JSS article<a class="anchor" aria-label="anchor" href="#jss-article"></a>
</h2>
<p>For a complete overview of the software, please refer to the Journal
of Statistical Software paper: ‚ÄúA Recipe for inferference: Start with
Causal Inference. Add Interference. Mix Well with R.‚Äù</p>
</div>
<div class="section level2">
<h2 id="using-inferference">Using inferference<a class="anchor" aria-label="anchor" href="#using-inferference"></a>
</h2>
<div class="section level3">
<h3 id="users-guide">User‚Äôs guide<a class="anchor" aria-label="anchor" href="#users-guide"></a>
</h3>
<p>The list below details the arguments for <code>interference</code>,
the primary function in <code>inferference</code>. Special attention
should be given to the <code>propensity_integrand</code> and
<code>formula</code> arguments.</p>
<ul>
<li>
<code>formula</code>: formula used to define the causal model.
<code>formula</code> has a minimum of 4 parts, separated by
<code>|</code> and <code>~</code> in a specific structure:
<code>outcome | exposure ~ covariates | group</code>. The order matters,
and the pipes (<code>|</code>) split the data frame into corresponding
pieces . The <code>exposure ~ covariates</code> piece is passed as a
single formula to the chosen <code>model_method</code> (defined below)
used to estimate or fix propensity parameters.
<ul>
<li>The following includes a random effect for the group:
<code>outcome | exposure ~ covariates + (1|group) | group</code>. In
this instance, the group variable appears twice.</li>
<li>If the study design includes a ‚Äúparticipation‚Äù variable (as in both
examples below), this is easily added to the formula:
<code>outcome | exposure | participation ~ covariates | group</code>.</li>
</ul>
</li>
<li>
<code>propensity_integrand</code>: a function, which may be created
by the user, used to compute the IP weights. This defaults to the
function <code><a href="../reference/logit_integrand.html">logit_integrand()</a></code>, which calculates the product of
inverse logits for individuals in a group:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>‚àè</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>i</mi></msub></msubsup><mo stretchy="false" form="prefix">{</mo><mi>r</mi><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>b</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><msup><mo stretchy="false" form="postfix">}</mo><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></msup><mo stretchy="false" form="prefix">{</mo><mn>1</mn><mo>‚àí</mo><mi>r</mi><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>b</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><msup><mo stretchy="false" form="postfix">}</mo><mrow><mn>1</mn><mo>‚àí</mo><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow></msup><msub><mi>f</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>b</mi><mi>i</mi></msub><mo>;</mo><msub><mi>Œ∏</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\prod_{j = 1}^{n_i} \{r h_{ij}(b_i)\}^{A_{ij}}\{1 - r h_{ij}(b_i)\}^{1 - A_{ij}}  f_b(b_i; \theta_s)</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>b</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mtext mathvariant="normal">logit</mtext><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêó</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>Œ∏</mi><mi>x</mi></msub><mo>+</mo><msub><mi>b</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_{ij}(b_i) = \mbox{logit}^{-1}(\mathbf{X}_{ij}\theta_x + b_i)</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mi>i</mi></msub><annotation encoding="application/x-tex">b_i</annotation></semantics></math>
is a group-level random effect,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>b</mi></msub><annotation encoding="application/x-tex">f_b</annotation></semantics></math>
is a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msub><mi>Œ∏</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N(0, \theta_s)</annotation></semantics></math>
density, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
is a known constant. In an observational study typically
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">r = 1</annotation></semantics></math>.
The examples below include individual randomized experiments in which
case
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
denotes the randomization probability among trial participants.
<code><a href="../reference/logit_integrand.html">logit_integrand()</a></code> is the integrand of ,
<code><a href="../reference/logit_integrand.html">logit_integrand()</a></code> ignores the random effect. IP weights are
computed by numerically integrating <code>propensity_integrand</code>
over the random effect distribution using by
<code><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">stats::integrate()</a></code> to which arguments may be passed via
<code>...</code> (see below). The default <code><a href="../reference/logit_integrand.html">logit_integrand()</a></code>
also takes the following argument that can be passed via the
<code>...</code> argument in <code><a href="../reference/interference.html">interference()</a></code>:
<ul>
<li>
<code>randomization</code>: a scalar. This is the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
in the formula just above. It defaults to 1 in the case that a
<code>participation</code> vector is not included. The vaccine study
example below demonstrates use of this argument.</li>
</ul>
</li>
<li>
<code>loglihood_integrand</code>: a function, which may be created
by the user, that defines the log likelihood of the propensity score
model. This should generally be the same function as
`propensity_integrand}, which is the default.</li>
<li>
<code>allocations</code>: a vector of values in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math>.
Increasing the number of elements of the allocation vector increases
computation time; however, a larger number of allocations will make
plotted effect estimates smoother. A minimum of two allocations is
required.</li>
<li>
<code>data</code>: the analysis data frame. This must include all
the variables defined in the `formula}.</li>
<li>
<code>model_method</code>: the method used to estimate or set the
propensity model parameters. Must be one of <code>'glm'</code>,
<code>'glmer'</code>, or <code>'oracle'</code>. For a fixed effects only
model use <code>'glm'</code>, or to include random effects use
<code>lme4</code>‚Äôs <code>'glmer'</code> <span class="citation">(Bates
et al. 2014)</span>. <code>logit_integrand</code> only supports a single
random effect for the grouping variable, corresponding to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mi>i</mi></msub><annotation encoding="application/x-tex">b_i</annotation></semantics></math>.
When the propensity parameters are known (as in simulations) or if
estimating parameters for the propensity model outside of
<code>interference</code>, use the <code>'oracle'</code> option. See
<code>model_options</code> for details on how to pass the oracle
parameters. Defaults to <code>'glmer'</code>}.</li>
<li>
<code>model_options</code>: a list of options passed to the function
in <code>model_method</code>. Defaults to
<code>list(family = binomial(link = 'logit'))</code>. When
<code>model_method = 'oracle'</code>, the list must have two elements,
<code>fixed.effects</code> and <code>random.effects</code>. If the model
does not include random effects, set
<code>random.effects = NULL</code>.</li>
<li>
<code>causal_estimation_method</code>: currently only supports and
defaults to <code>'ipw'</code>.</li>
<li>
<code>causal_estmation_options</code>: a list with a single item
<code>variance_estimation</code>, which is either <code>'naive'</code>
or <code>'robust'</code>. Defaults to <code>'robust'</code>.</li>
<li>
<code>conf.level</code>: level for confidence intervals. Defaults to
<code>0.95</code>.</li>
<li>
<code>rescale.factor</code>: a scalar multiplication factor by which
to rescale outcomes and effects. Defaults to <code>1</code>.</li>
<li>
<code>integrate_allocation</code>: indicator of whether the
integrand function uses the allocation parameter. Defaults to TRUE.</li>
<li>
<code>...</code>: used to pass additional arguments to internal
functions such as <code><a href="https://rdrr.io/pkg/numDeriv/man/grad.html" class="external-link">numDeriv::grad()</a></code> or
<code><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">stats::integrate()</a></code>. Arguments can also be passed to the
<code>propensity_integrand</code> and <code>loglihood_integrand</code>
functions.</li>
</ul>
</div>
<div class="section level3">
<h3 id="the-interference-object">The interference object<a class="anchor" aria-label="anchor" href="#the-interference-object"></a>
</h3>
<p>An <code><a href="../reference/interference.html">interference()</a></code> call results in an <code>S3</code>
object of class <code>interference</code> which contains:</p>
<ul>
<li>
<code>estimates</code>: a data frame of causal effect
estimates;</li>
<li>
<code>models$propensity_model</code>: the <code>glm</code> or
<code>glmer</code> object;</li>
<li>
<code>summary</code>: a list of objects summarizing the causal model
such as the number of groups, number of allocations, and the formula
used in the <code>interference</code> call;</li>
<li>
<code>weights</code>: (# of groups)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>√ó</mo><annotation encoding="application/x-tex">\times</annotation></semantics></math>
(# of allocations) matrix of group-level weights:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mo>,</mo><mi>k</mi></mrow></msub><mo>=</mo><mfrac><mrow><msub><mi>œÄ</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo>;</mo><msub><mi>Œ±</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>f</mi><mrow><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mover><mi>ùõâ</mi><mo accent="true">ÃÇ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mi>.</mi></mrow><annotation encoding="application/x-tex">
w_{i, k} = \frac{\pi_i(\mathbf{A}_i; \alpha_k)}{f_{\mathbf{A}_i|\mathbf{X}_i}(\mathbf{A}_i|\mathbf{X}_i; \hat{\boldsymbol{\theta}})}.
</annotation></semantics></math>
</li>
</ul>
<p>If <code>variance_estimation = 'robust'</code>, then the object also
includes:</p>
<ul>
<li>
<code>weightd</code>: (# of groups)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>√ó</mo><annotation encoding="application/x-tex">\times</annotation></semantics></math>
(# of allocations)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>√ó</mo><annotation encoding="application/x-tex">\times</annotation></semantics></math>
(# of parameters) array of weights computed using derivatives of the
propensity function with respect to each parameter;</li>
<li>
<code>scores</code>: (# of groups)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>√ó</mo><annotation encoding="application/x-tex">\times</annotation></semantics></math>
(# of parameters) matrix of derivatives of the log likelihood.</li>
</ul>
</div>
<div class="section level3">
<h3 id="utility-functions">Utility functions<a class="anchor" aria-label="anchor" href="#utility-functions"></a>
</h3>
<p>The package includes tools to extract effect estimates of interest
from the <code>S3</code> object. The functions
<code>direct_effect</code>, <code>indirect_effect</code> (or
<code>ie</code>), <code>total_effect</code> (or <code>te</code>), and
<code>overall_effect</code> (or <code>oe</code>) select appropriate
records from the <code>estimates</code> data frame in the
<code>interference</code> object.</p>
</div>
</div>
<div class="section level2">
<h2 id="example-vaccine-study">Example: Vaccine Study<a class="anchor" aria-label="anchor" href="#example-vaccine-study"></a>
</h2>
<p>This section illustrates the use of <code>inferference</code> with an
example drawn from vaccine research. The package includes a single
dataset based on the same set of parameters used in the simulation study
by <span class="citation">Perez-Heydrich et al. (2014)</span>. The
<code>vaccinesim</code> dataset consists of 3000 units in 250 groups and
contains two covariates (<code>X1</code> = age in decades and
<code>X2</code> = distance to river), a vaccination indicator
(<code>A</code>), a participation indicator (<code>B</code>), a binary
outcome (<code>Y</code>) indicating cholera infection (1 yes, 0 no), and
the unit‚Äôs <code>group</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(inferference)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">head</span>(vaccinesim)</span></code></pre></div>
<pre><code><span><span class="co">##   Y        X1       X2 A B group</span></span>
<span><span class="co">## 1 1 5.3607405 1.715527 0 0     1</span></span>
<span><span class="co">## 2 0 0.1964597 1.730802 0 1     1</span></span>
<span><span class="co">## 3 0 0.4846243 1.769546 1 1     1</span></span>
<span><span class="co">## 4 0 0.8012977 1.715527 0 1     1</span></span>
<span><span class="co">## 5 0 2.1426629 1.772158 1 1     1</span></span>
<span><span class="co">## 6 0 1.2861017 1.715527 0 1     1</span></span></code></pre>
<p>Like the original study <span class="citation">(Ali et al.
2005)</span> that inspired the simulation, individuals were randomized
to vaccine with a known probability of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>/</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">2/3</annotation></semantics></math>,
but subjects could opt to not participate in the trial. In essence,
there are both experimental and observational aspects to the data. The
<code>interference</code> function handles this design when
<code>logit_integrand</code>‚Äôs <code>randomization</code> argument is
used and a participation variable is included in the formula.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="sc">&gt;</span> example1 <span class="ot">&lt;-</span> <span class="fu">interference</span>(</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="sc">+</span>     <span class="at">formula =</span> Y <span class="sc">|</span> A <span class="sc">|</span> B <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>group) <span class="sc">|</span> group, </span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="sc">+</span>     <span class="at">allocations =</span> <span class="fu">c</span>(.<span class="dv">3</span>, .<span class="dv">45</span>,  .<span class="dv">6</span>), </span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="sc">+</span>     <span class="at">data =</span> vaccinesim, </span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="sc">+</span>     <span class="at">randomization =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>,</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="sc">+</span>     <span class="at">method =</span> <span class="st">'simple'</span>)</span></code></pre></div>
<p>The only arguments required for <code>interference</code> to run are
<code>formula</code>, <code>allocations</code>, and <code>data</code>.
When using the `<code>robust'</code> method (the default) to compute the
variance, the internal workings call <code><a href="https://rdrr.io/pkg/numDeriv/man/grad.html" class="external-link">numDeriv::grad</a></code> <span class="citation">(Gilbert and Varadhan 2012)</span> and
<code><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">stats::integrate</a></code> frequently. The option
<code>method = 'simple'</code> greatly speeds up the
<code><a href="https://rdrr.io/pkg/numDeriv/man/grad.html" class="external-link">numDeriv::grad</a></code> function. For more accurate derivatives,
leave out this option. See <code><a href="https://rdrr.io/pkg/numDeriv/man/grad.html" class="external-link">?numDeriv::grad</a></code> for more
options.</p>
<p>The <code>print.interference</code> function provides an overview of
the causal effect estimates, estimated standard errors, and Wald-type
confidence intervals. In the output, <code>alpha1</code> and
<code>alpha2</code> refer to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ±</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ±</mi><mi>‚Ä≤</mi></mrow><annotation encoding="application/x-tex">\alpha'</annotation></semantics></math>,
while <code>trt1</code> and <code>trt2</code> refer to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>a</mi><mn>1</mn></msub><annotation encoding="application/x-tex">a_1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>a</mi><mn>2</mn></msub><annotation encoding="application/x-tex">a_2</annotation></semantics></math>,
respectively.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(example1)</span></code></pre></div>
<pre><code><span><span class="co">##  --------------------------------------------------------------------------</span></span>
<span><span class="co">##                                Model Summary                    </span></span>
<span><span class="co">##  --------------------------------------------------------------------------</span></span>
<span><span class="co">##  Formula: Y | A | B ~ X1 + X2 + (1 | group) | group </span></span>
<span><span class="co">##  Number of groups:  250 </span></span>
<span><span class="co">##  3 allocations were used from 0.3 (min) to 0.6 (max) </span></span>
<span><span class="co">##  --------------------------------------------------------------------------</span></span>
<span><span class="co">##                           Causal Effect Summary                            </span></span>
<span><span class="co">##                          Confidence level: 0.95                       </span></span>
<span><span class="co">##                          Variance method: robust        </span></span>
<span><span class="co">##  --------------------------------------------------------------------------</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Direct Effects</span></span>
<span><span class="co">##  alpha1 trt1 alpha2 trt2 estimate std.error conf.low conf.high</span></span>
<span><span class="co">##    0.30    0   0.30    1   0.1605   0.02474  0.11202    0.2090</span></span>
<span><span class="co">##    0.60    0   0.60    1   0.1086   0.01857  0.07219    0.1450</span></span>
<span><span class="co">##    0.45    0   0.45    1   0.1339   0.01778  0.09904    0.1687</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Indirect Effects</span></span>
<span><span class="co">##  alpha1 trt1 alpha2 trt2 estimate std.error conf.low conf.high</span></span>
<span><span class="co">##    0.30    0   0.60    0  0.15907   0.02617  0.10777    0.2104</span></span>
<span><span class="co">##    0.30    0   0.45    0  0.08657   0.01732  0.05263    0.1205</span></span>
<span><span class="co">##    0.45    0   0.60    0  0.07250   0.01408  0.04490    0.1001</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Total Effects </span></span>
<span><span class="co">##  alpha1 trt1 alpha2 trt2 estimate std.error conf.low conf.high</span></span>
<span><span class="co">##    0.30    0   0.60    1   0.2677   0.02435   0.2199    0.3154</span></span>
<span><span class="co">##    0.30    0   0.45    1   0.2205   0.02469   0.1721    0.2688</span></span>
<span><span class="co">##    0.45    0   0.60    1   0.1811   0.01841   0.1450    0.2172</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  Overall Effects </span></span>
<span><span class="co">##  alpha1 trt1 alpha2 trt2 estimate std.error conf.low conf.high</span></span>
<span><span class="co">##    0.30   NA   0.60   NA  0.17607  0.019247  0.13835    0.2138</span></span>
<span><span class="co">##    0.30   NA   0.45   NA  0.09867  0.014207  0.07083    0.1265</span></span>
<span><span class="co">##    0.45   NA   0.60   NA  0.07740  0.008981  0.05980    0.0950</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  --------------------------------------------------------------------------</span></span></code></pre>
<p>The utility functions return selected effect estimates.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">direct_effect</span>(example1, .<span class="dv">3</span>)</span></code></pre></div>
<pre><code><span><span class="co">##   alpha1 trt1 alpha2 trt2  estimate  std.error  conf.low conf.high</span></span>
<span><span class="co">## 1    0.3    0    0.3    1 0.1605036 0.02473782 0.1120184 0.2089888</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">ie</span>(example1, .<span class="dv">3</span>)</span></code></pre></div>
<pre><code><span><span class="co">##   alpha1 trt1 alpha2 trt2   estimate  std.error   conf.low conf.high</span></span>
<span><span class="co">## 1    0.3    0   0.30    0 0.00000000 0.00000000 0.00000000 0.0000000</span></span>
<span><span class="co">## 2    0.3    0   0.45    0 0.08656992 0.01731878 0.05262574 0.1205141</span></span>
<span><span class="co">## 3    0.3    0   0.60    0 0.15906887 0.02617398 0.10776882 0.2103689</span></span></code></pre>
<div class="section level3">
<h3 id="plotting-effect-estimates">Plotting effect estimates<a class="anchor" aria-label="anchor" href="#plotting-effect-estimates"></a>
</h3>
<p>Plots of effect estimates over a range of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ±</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
levels may be helpful in summarizing results. <span class="citation">Perez-Heydrich et al. (2014)</span> present several
such graphical displays. Here we demonstrate how to generate similar
plots of effect estimates using <code>inferference</code>.</p>
<p>First, we estimate the effects over a dense sequence of allocations
so that lines will be smooth.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="sc">&gt;</span> example2 <span class="ot">&lt;-</span> <span class="fu">interference</span>( <span class="at">formula =</span> Y <span class="sc">|</span> A <span class="sc">|</span> B <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>group) <span class="sc">|</span> group, </span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="sc">+</span>     <span class="at">allocations =</span> <span class="fu">seq</span>(.<span class="dv">2</span>, .<span class="dv">8</span>, <span class="at">by =</span> .<span class="dv">1</span>), </span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="sc">+</span>     <span class="at">data =</span> vaccinesim, <span class="at">randomization =</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">method =</span> <span class="st">'simple'</span>)</span></code></pre></div>
<p>In the plots, we present the direct and indirect effect estimates
over this range of allocations. For direct effects, a simple scatterplot
showing the point-wise confidence intervals suffices. One approach with
indirect effects fixes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ±</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
and plots estimates over a range of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ±</mi><mi>‚Ä≤</mi></mrow><annotation encoding="application/x-tex">\alpha'</annotation></semantics></math>,
whereas a contour plot displays all pairwise
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œ±</mi><mo>,</mo><mi>Œ±</mi><mi>‚Ä≤</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(\alpha, \alpha')</annotation></semantics></math>
comparisons over a range of allocation strategies.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="sc">&gt;</span> deff <span class="ot">&lt;-</span> <span class="fu">direct_effect</span>(example2)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="sc">&gt;</span> x <span class="ot">&lt;-</span> deff<span class="sc">$</span>alpha1</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(deff<span class="sc">$</span>estimate)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="sc">&gt;</span> u <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(deff<span class="sc">$</span>conf.high)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="sc">&gt;</span> l <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(deff<span class="sc">$</span>conf.low)</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(<span class="fu">c</span>(<span class="fu">min</span>(x), <span class="fu">max</span>(x)), <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">15</span>, .<span class="dv">25</span>), <span class="at">type =</span> <span class="st">'n'</span>, <span class="at">bty =</span> <span class="st">'l'</span>,</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="sc">+</span>      <span class="at">xlab =</span> <span class="fu">expression</span>(alpha), <span class="at">ylab =</span> <span class="st">''</span> )</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">title</span>(<span class="at">ylab =</span> <span class="fu">expression</span>(<span class="fu">widehat</span>(DE) <span class="sc">*</span> <span class="st">"("</span> <span class="sc">*</span> alpha <span class="sc">*</span> <span class="st">")"</span>),</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="sc">+</span>       <span class="at">line =</span> <span class="dv">2</span>)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">polygon</span>(<span class="fu">c</span>(x, <span class="fu">rev</span>(x)), <span class="fu">c</span>(u, <span class="fu">rev</span>(l)), <span class="at">col =</span> <span class="st">'skyblue'</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">lines</span>(x, y, <span class="at">cex =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="inferference_intro_files/figure-html/deff_plot-1.png" width="576"></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="sc">&gt;</span> ieff<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">ie</span>(example2, <span class="at">allocation1 =</span> .<span class="dv">4</span>)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="sc">&gt;</span> x <span class="ot">&lt;-</span> ieff<span class="fl">.4</span><span class="sc">$</span>alpha2</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(ieff<span class="fl">.4</span><span class="sc">$</span>estimate)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="sc">&gt;</span> u <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(ieff<span class="fl">.4</span><span class="sc">$</span>conf.high)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="sc">&gt;</span> l <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(ieff<span class="fl">.4</span><span class="sc">$</span>conf.low)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(<span class="fu">c</span>(<span class="fu">min</span>(x), <span class="fu">max</span>(x)),<span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">15</span>, .<span class="dv">25</span>), <span class="at">type =</span> <span class="st">'n'</span>, <span class="at">bty =</span> <span class="st">'l'</span>,</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="sc">+</span>      <span class="at">xlab =</span> <span class="fu">expression</span>(alpha <span class="sc">*</span> <span class="st">"'"</span>), <span class="at">ylab =</span> <span class="st">''</span>)</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">title</span>(<span class="at">ylab =</span> <span class="fu">expression</span>(<span class="fu">widehat</span>(IE) <span class="sc">*</span> <span class="st">"("</span> <span class="sc">*</span> <span class="fl">0.4</span> <span class="sc">*</span> <span class="st">","</span> <span class="sc">*</span> alpha <span class="sc">*</span> <span class="st">"'"</span> <span class="sc">*</span> <span class="st">")"</span>),</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="sc">+</span>       <span class="at">line =</span> <span class="dv">2</span>)</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">polygon</span>(<span class="fu">c</span>(x, <span class="fu">rev</span>(x)), <span class="fu">c</span>(u, <span class="fu">rev</span>(l)), <span class="at">col =</span> <span class="st">'skyblue'</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">lines</span>(x, y, <span class="at">cex =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="inferference_intro_files/figure-html/ieff_plot-1.png" width="576"></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="sc">&gt;</span> ieff <span class="ot">&lt;-</span> <span class="fu">subset</span>(example2[[<span class="st">"estimates"</span>]], effect <span class="sc">==</span> <span class="st">'indirect'</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="sc">&gt;</span> x <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(ieff<span class="sc">$</span>alpha1))</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(ieff<span class="sc">$</span>alpha2))</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="sc">&gt;</span> z <span class="ot">&lt;-</span> <span class="fu">xtabs</span>(estimate <span class="sc">~</span> alpha1 <span class="sc">+</span> alpha2, <span class="at">data=</span> ieff)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">contour</span>(x, y, z, <span class="at">xlab =</span> <span class="fu">expression</span>(alpha), </span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="sc">+</span>         <span class="at">ylab =</span> <span class="fu">expression</span>(alpha <span class="sc">*</span> <span class="st">"'"</span>), <span class="at">bty =</span> <span class="st">'l'</span>)</span></code></pre></div>
<p><img src="inferference_intro_files/figure-html/ieff_contour-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a>
</h3>
<p>IPW estimators are known to be unstable if the weights range greatly.
The package includes a basic utility to check the performance of the
group-level weights,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mi>i</mi><mo>,</mo><mi>k</mi></mrow></msub><annotation encoding="application/x-tex">w_{i,k}</annotation></semantics></math>,
for multiple allocations. The function <code>diagnose_weights</code>
plots histograms of weights for chosen allocation levels. If the
<code>allocations</code> argument is left <code>NULL</code>, the
function plots histograms for five allocation levels used the
<code>interference</code> call. The plot below shows the resulting
histogram for a single allocation. The analyst should examine groups
with extreme weights, which may unduly influence population-level
estimates.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">diagnose_weights</span>(example2, <span class="at">allocations =</span> .<span class="dv">5</span>, <span class="at">breaks =</span> <span class="dv">30</span>)</span></code></pre></div>
<p><img src="inferference_intro_files/figure-html/diagnostic-1.png" width="432"></p>
</div>
</div>
<div class="section level2">
<h2 id="example-voting-experiment">Example: Voting Experiment<a class="anchor" aria-label="anchor" href="#example-voting-experiment"></a>
</h2>
<p>The preceding example used the default <code>logit_integrand</code>
function to define the group-level propensities. The following example
demonstrates how to customize the propensity score function.</p>
<p><span class="citation">Nickerson (2008)</span> reported an experiment
on voter behavior to examine peer-to-peer indirect effects on voting
participation. The experiment randomized households with only two
registered voters in Denver and Minneapolis to receive one of three
assignments: voting encouragement, recycling encouragement, or nothing.
Canvassers knocked on doors of households randomized to the voting or
recycling groups a week before the 2002 primary. If a registered voter
answered the door, the canvassers delivered a scripted message about
voting (treatment) or recycling (control). The researchers used voter
turnout records to determine if each member of the household then voted
in the election. Nickerson was interested in the potential spillover
effect of the voting encouragement to the untreated individual via the
treated individual. From analysis of the observed data, he concluded
there was a ‚Äúsecondary effect‚Äù where the household members not contacted
by the canvassers voted more often in the treatment groups compared to
the control groups.</p>
<p>The dataset <code>voters</code> contains information for 3861
households, 2549 in Denver and 1312 in Minneapolis, including covariates
such as age, gender, previous voting history, and party affiliation. Our
estimand of interest involves average voting outcomes when households
receive voting encouragement compared to when household receive the
recycling message, hence we exclude households not contacted by
canvassers. We also exclude the single household where a canvasser
appears to have contacted both registered voters.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="sc">&gt;</span> voters <span class="ot">&lt;-</span>  <span class="fu">within</span>(voters, {</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="sc">+</span>     treated     <span class="ot">=</span> (treatment <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> reached <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">1</span> </span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="sc">+</span>     c_age       <span class="ot">=</span> (age <span class="sc">-</span> <span class="fu">mean</span>(age))<span class="sc">/</span><span class="dv">10</span> </span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="sc">+</span>    })</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="sc">&gt;</span> reach_cnt <span class="ot">&lt;-</span> <span class="fu">tapply</span>(voters<span class="sc">$</span>reached, voters<span class="sc">$</span>family, sum)</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="sc">&gt;</span> voters <span class="ot">&lt;-</span> voters[<span class="sc">!</span>(voters<span class="sc">$</span>family <span class="sc">%in%</span> <span class="fu">names</span>(reach_cnt[reach_cnt <span class="sc">&gt;</span> <span class="dv">1</span>])), ]</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="sc">&gt;</span> voters <span class="ot">&lt;-</span> voters[voters<span class="sc">$</span>hsecontact <span class="sc">==</span> <span class="dv">1</span>, ]</span></code></pre></div>
<div class="section level3">
<h3 id="household-level-propensity">Household-level propensity<a class="anchor" aria-label="anchor" href="#household-level-propensity"></a>
</h3>
<p>Unlike the vaccine study example, in this data set randomization
occurred at the group level but individual level treatment was not
randomized. With only two subjects,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>A</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{A}_i = (A_{i1}, A_{i2})</annotation></semantics></math>
is the treatment allocation for group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùêó</mi><mi>i</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêó</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>ùêó</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{X}_i = (\mathbf{X}_{i1}, \mathbf{X}_{i2})</annotation></semantics></math>
is the matrix of individuals‚Äô covariate matrices for group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>.
Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùêÅ</mi><mi>i</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>B</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>B</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{B}_i = (B_{i1}, B_{i2})</annotation></semantics></math>
be indicators of being reached by a canvasser in group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>.
Since we only consider households where someone answered the door,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùêÅ</mi><mi>i</mi></msub><mo>‚àà</mo><mo stretchy="false" form="prefix">{</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>,</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\mathbf{B}_i \in \{(1, 0), (0, 1)\}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>B</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo>=</mo><mn>1</mn><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>B</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><mo>=</mo><mn>1</mn><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\Pr(B_{i1} = 1| \mathbf{X}_{i}) + \Pr(B_{i2} = 1| \mathbf{X}_{i}) = 1</annotation></semantics></math>.
Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>B</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mtext mathvariant="normal">logit</mtext><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêó</mi><mi>i</mi></msub><msub><mi>Œ∏</mi><mi>x</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_{ij} = \Pr(B_{ij} = 1| \mathbf{X}_{i}; \theta) = \mbox{logit}^{-1}(\mathbf{X}_{i}\theta_x)</annotation></semantics></math>.
Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>i</mi></msub><mo>‚àà</mo><mo stretchy="false" form="prefix">{</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">G_i \in \{0, 1\}</annotation></semantics></math>
be the indicator that group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
is randomized to treatment (1) or control (0). By design,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">\Pr(G_i = 1) = 0.5</annotation></semantics></math>.
Since
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>1</mn><mo>‚àí</mo><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\Pr(A_{i1} | \mathbf{X}_i; \theta) = 1 - \Pr(A_{i2} | \mathbf{X}_i; \theta)</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\Pr(\mathbf{A}_i | \mathbf{X}_i; \theta)</annotation></semantics></math>
can arbitrarily be defined in terms of either household member. By
convention we use the first subject (subject one) of each group found in
the dataset. Among treated groups, the probability of subject one being
treated is the probability that a canvasser reached subject one. That
is,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>A</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo>,</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mi>h</mi><mrow><mi>i</mi><mn>1</mn></mrow><msub><mi>A</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub></msubsup><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><msub><mi>h</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mn>1</mn><mo>‚àí</mo><msub><mi>A</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\Pr(A_{i1} | G_{i} = 1, \mathbf{X}_i; \theta) = h_{i1}^{A_{i1}}(1 - h_{i1})^{1 - A_{i1}}</annotation></semantics></math>.
Thus, the group-level propensity can be expressed:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo>,</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn><mo>,</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mn>0.5</mn><mo stretchy="false" form="prefix">{</mo><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo>,</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn><mo>,</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">}</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><mn>.5</mn></mtd><mtd columnalign="left" style="text-align: left"><mrow><mtext mathvariant="normal">if </mtext><mspace width="0.333em"></mspace></mrow><mrow><msub><mi>A</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo>=</mo><mn>0</mn><mo>,</mo><msub><mi>A</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><mo>=</mo><mn>0</mn></mrow><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> and </mtext><mspace width="0.333em"></mspace></mrow><mrow><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mn>.5</mn><msubsup><mi>h</mi><mrow><mi>i</mi><mn>1</mn></mrow><msub><mi>A</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub></msubsup><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><msub><mi>h</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mn>1</mn><mo>‚àí</mo><msub><mi>A</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub></mrow></msup></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">if (</mtext><mrow><msub><mi>A</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo>=</mo><mn>0</mn><mo>,</mo><msub><mi>A</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><mo>=</mo><mn>1</mn></mrow><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> or </mtext><mspace width="0.333em"></mspace></mrow><mrow><msub><mi>A</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo>=</mo><mn>1</mn><mo>,</mo><msub><mi>A</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><mo>=</mo><mn>0</mn></mrow><mrow><mtext mathvariant="normal">) and </mtext><mspace width="0.333em"></mspace></mrow><mrow><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mn>0</mn></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">otherwise</mtext></mtd></mtr></mtable></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*} 
\Pr(\mathbf{A}_i | \mathbf{X}_i ; \theta) &amp;= \Pr(\mathbf{A}_i | G_i = 1, \mathbf{X}_i ; \theta)\Pr(G_i = 1) + \Pr(\mathbf{A}_i | G_i = 0, \mathbf{X}_i ; \theta)\Pr(G_i = 0) \\
&amp;= 0.5 \{ \Pr(\mathbf{A}_i | G_i = 1, \mathbf{X}_i ; \theta) +  \Pr(\mathbf{A}_i | G_i = 0, \mathbf{X}_i ; \theta) \} \\
&amp;= \begin{cases} .5 &amp; \text{if $A_{i1} = 0, A_{i2} = 0$ and $G_i = 0$} \\
.5 h_{i1}^{A_{i1}}(1 - h_{i1})^{1 - A_{i1}} &amp; \text{if ($A_{i1} = 0, A_{i2} = 1$ or $A_{i1} = 1, A_{i2} = 0$) and $G_i = 1$}  \\
0  &amp; \text{otherwise} \end{cases} \\
\end{align*}</annotation></semantics></math></p>
<p>Thus,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>h</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><annotation encoding="application/x-tex">h_{i1}</annotation></semantics></math>
is sufficient to determine the group-level propensity. If we know
whether or not the first subject was reached by a canvasser, then we
know if the second was. Therefore, we can estimate parameters for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>h</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><annotation encoding="application/x-tex">h_{i1}</annotation></semantics></math>
with a dataset that includes only subject one from each group. To do
this, we must estimate the parameters outside of
<code>inferference</code> and use <code>model_method = 'oracle'</code>.
We include centered age (in decades) in the propensity model for
demonstration purposes.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="sc">&gt;</span> voters1 <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">by</span>(voters, voters[, <span class="st">'family'</span>], <span class="cf">function</span>(x) x[<span class="dv">1</span>, ]))</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="sc">&gt;</span> coef.voters <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">glm</span>(reached <span class="sc">~</span> c_age, <span class="at">data =</span> voters1, </span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="sc">+</span>                      <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">'logit'</span>)))</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="coding-the-propensity-function">Coding the propensity function<a class="anchor" aria-label="anchor" href="#coding-the-propensity-function"></a>
</h3>
<p>Custom <code>propensity_integrand</code> and
<code>loglihood_integrand</code> functions must have at least one
argument:</p>
<ul>
<li>
<code>b</code>: the first argument is the variable for which the
<code>integrate</code> function computes the integral. As in this
example, the function can be written so that the integral evaluates to 1
and has no effect.</li>
</ul>
<p>For example, the following function will fix the group-level
propensity to 0.5 for all groups when
<code>variance_estimation = "naive"</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="sc">&gt;</span> fixed_propensity <span class="ot">&lt;-</span> <span class="cf">function</span>(b){</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="sc">+</span>   <span class="fu">return</span>(<span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">dnorm</span>(b))</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="sc">+</span> }</span></code></pre></div>
<p>For more realistic models, additional arguments may be passed to the
custom function:</p>
<ul>
<li>
<code>X</code>: the covariate matrix (determined by the `formula})
for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>th
group</li>
<li>
<code>A</code>: the vector of treatment indicators for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>th
group</li>
<li>
<code>parameters</code>: vector of estimated parameters from the
<code>model_method</code> * <code>allocation</code>: the allocation
level for which the propensity is currently being estimated</li>
<li>
<code>...</code>: other arguments can be passed via the ellipsis in
<code>interference</code> Now we have the pieces to write the propensity
function for the voting example.</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="sc">&gt;</span> household_propensity <span class="ot">&lt;-</span> <span class="cf">function</span>(b, X, A, </span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="sc">+</span>                                  parameters, </span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="sc">+</span>                                  <span class="at">group.randomization =</span> .<span class="dv">5</span>){</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="sc">+</span>   <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.matrix</span>(X)){</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="sc">+</span>     X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X)</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="sc">+</span>   }   </span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="sc">+</span>   <span class="cf">if</span>(<span class="fu">sum</span>(A) <span class="sc">==</span> <span class="dv">0</span>){ </span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="sc">+</span>     pr <span class="ot">&lt;-</span>  group.randomization</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="sc">+</span>   } <span class="cf">else</span> { </span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="sc">+</span>     X<span class="fl">.1</span> <span class="ot">&lt;-</span> X[<span class="dv">1</span> ,]; A<span class="fl">.1</span> <span class="ot">&lt;-</span> A[<span class="dv">1</span>] </span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="sc">+</span>     h   <span class="ot">&lt;-</span> <span class="fu">plogis</span>(X<span class="fl">.1</span> <span class="sc">%*%</span> parameters)</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="sc">+</span>     pr  <span class="ot">&lt;-</span>  group.randomization <span class="sc">*</span> <span class="fu">dbinom</span>(A<span class="fl">.1</span>, <span class="dv">1</span>, h)</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a><span class="sc">+</span>   }   </span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="sc">+</span>   out <span class="ot">&lt;-</span> pr <span class="sc">*</span> <span class="fu">dnorm</span>(b) </span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a><span class="sc">+</span>   out</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a><span class="sc">+</span> }</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="evidence-of-a-peer-influence-effect">Evidence of a peer influence effect<a class="anchor" aria-label="anchor" href="#evidence-of-a-peer-influence-effect"></a>
</h3>
<p>The influence of the door opener on the non-door opener‚Äôs voting
behavior corresponds to an indirect effect. Though the Bernoulli-type
parametrization of the estimands allows us to look at a range of
allocations,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mrow><mi>I</mi><mi>E</mi></mrow><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mn>0.5</mn><mo>,</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\widehat{IE}(0.5, 0)</annotation></semantics></math>
makes the sensible comparison between a world where individuals receive
a voting message with probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0.5</mn><annotation encoding="application/x-tex">0.5</annotation></semantics></math>
to a world where individuals have zero probability of receiving the
voting message.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="sc">&gt;</span> example3 <span class="ot">&lt;-</span> <span class="fu">interference</span>(</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="sc">+</span>   <span class="at">formula =</span> voted02p <span class="sc">|</span> treated <span class="sc">|</span> reached <span class="sc">~</span> c_age <span class="sc">|</span> family,</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="sc">+</span>   <span class="at">propensity_integrand =</span> <span class="st">'household_propensity'</span>,</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="sc">+</span>   <span class="at">data =</span> voters,</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="sc">+</span>   <span class="at">model_method =</span> <span class="st">'oracle'</span>, </span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="sc">+</span>   <span class="at">model_options =</span> <span class="fu">list</span>(<span class="at">fixed.effects =</span> coef.voters, <span class="at">random.effects =</span> <span class="cn">NULL</span>),</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="sc">+</span>   <span class="at">allocations   =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">5</span>),</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="sc">+</span>   <span class="at">integrate_allocation =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a><span class="sc">+</span>   <span class="at">causal_estimation_options =</span> <span class="fu">list</span>(<span class="at">variance_estimation =</span> <span class="st">'robust'</span>),</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a><span class="sc">+</span>   <span class="at">conf.level =</span> .<span class="dv">9</span>)</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">ie</span>(example3, .<span class="dv">5</span>, <span class="dv">0</span>)[ , <span class="fu">c</span>(<span class="st">'estimate'</span>, <span class="st">'conf.low'</span>, <span class="st">'conf.high'</span>)]</span></code></pre></div>
<pre><code><span><span class="co">##     estimate    conf.low  conf.high</span></span>
<span><span class="co">## 1 0.03151501 0.002290586 0.06073944</span></span></code></pre>
<p>The point estimate suggests an individual receiving the voting
encouragement increases the voting likelihood of the other household
member by 3.2%. The 90% confidence interval excludes zero, indicating a
significant indirect effect corroborating the analysis in <span class="citation">Nickerson (2008)</span>.</p>
<p>For comparison, suppose that a flip of a fair coin determined which
registered voter opened the door. We exclude age as a covariate and
instead set
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">h_{i1} = 0.5</annotation></semantics></math>.
Here we assume to know the propensity score, so we use
<code>variance_estimation = 'naive'</code>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="sc">&gt;</span> example4 <span class="ot">&lt;-</span> <span class="fu">interference</span>(</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="sc">+</span>   <span class="at">formula =</span> voted02p <span class="sc">|</span> treated <span class="sc">|</span> reached <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> family,</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="sc">+</span>   <span class="at">propensity_integrand =</span> <span class="st">'household_propensity'</span>,</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="sc">+</span>   <span class="at">data =</span> voters,</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="sc">+</span>   <span class="at">model_method =</span> <span class="st">'oracle'</span>,</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="sc">+</span>   <span class="at">model_options =</span> <span class="fu">list</span>(<span class="at">fixed.effects =</span> <span class="dv">0</span>, <span class="at">random.effects =</span> <span class="cn">NULL</span>),</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="sc">+</span>   <span class="at">allocations   =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">5</span>),</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="sc">+</span>   <span class="at">integrate_allocation =</span> <span class="cn">FALSE</span>,</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="sc">+</span>   <span class="at">causal_estimation_options =</span> <span class="fu">list</span>(<span class="at">variance_estimation =</span> <span class="st">'naive'</span>),</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a><span class="sc">+</span>   <span class="at">conf.level =</span> .<span class="dv">9</span>)</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">ie</span>(example4, .<span class="dv">5</span>, <span class="dv">0</span>)[ , <span class="fu">c</span>(<span class="st">'estimate'</span>, <span class="st">'conf.low'</span>, <span class="st">'conf.high'</span>)]</span></code></pre></div>
<pre><code><span><span class="co">##     estimate    conf.low  conf.high</span></span>
<span><span class="co">## 1 0.03144654 0.002209019 0.06068406</span></span></code></pre>
<p>Examining the group-level weights may help diagnose coding errors in
the propensity score function. In the case of a fixed probability as in
`example4}, the propensity weights are easily computed by hand. For
example, for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ±</mi><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.5</annotation></semantics></math>,</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub><mo>=</mo><mfrac><mrow><mi>œÄ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo>;</mo><mn>0.5</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>f</mi><mrow><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mi>Œ∏</mi><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><mfrac><msup><mn>0.5</mn><mn>2</mn></msup><mn>.5</mn></mfrac><mo>=</mo><mn>.5</mn></mtd><mtd columnalign="left" style="text-align: left"><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> if </mtext><mspace width="0.333em"></mspace></mrow><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mfrac><msup><mn>0.5</mn><mn>2</mn></msup><msup><mn>.5</mn><mn>2</mn></msup></mfrac><mo>=</mo><mn>1</mn></mtd><mtd columnalign="left" style="text-align: left"><mrow><mspace width="0.333em"></mspace><mtext mathvariant="normal"> if </mtext><mspace width="0.333em"></mspace></mrow><msub><mi>G</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"></mtd></mtr></mtable></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">
w_i = \frac{\pi(\mathbf{A}_i; 0.5)}{f_{\mathbf{A}_i | \mathbf{X}_i}(\mathbf{A}_i | \mathbf{X}_i; \theta = 0)} = \begin{cases} \frac{0.5^2}{.5} = .5 &amp; \text{ if } G_i = 0 \\
\frac{0.5^2}{.5^2} = 1 &amp; \text{ if } G_i = 1\\
 \end{cases},
</annotation></semantics></math></p>
<p>which we can confirm the software computed.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="sc">&gt;</span> G <span class="ot">&lt;-</span> <span class="fu">tapply</span>(voters[<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="st">'treated'</span>], voters[<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="st">'family'</span>], sum)</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="sc">&gt;</span> W <span class="ot">&lt;-</span> <span class="fu">head</span>(example4[[<span class="st">"weights"</span>]])[, <span class="dv">2</span>]</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">cbind</span>(G, W)</span></code></pre></div>
<pre><code><span><span class="co">##    G   W</span></span>
<span><span class="co">## 2  1 1.0</span></span>
<span><span class="co">## 4  0 0.5</span></span>
<span><span class="co">## 5  0 0.5</span></span>
<span><span class="co">## 6  0 0.5</span></span>
<span><span class="co">## 9  1 1.0</span></span>
<span><span class="co">## 10 0 0.5</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="computational-issues-with-ipw-estimators">Computational Issues with IPW Estimators<a class="anchor" aria-label="anchor" href="#computational-issues-with-ipw-estimators"></a>
</h2>
<p>We show in this section how computation of the group-level weights
may affect estimation as the number of individuals in groups grows. To
illustrate, consider the IPW estimator of the overall effect, which
weights individual outcomes in group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
with:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mn>1</mn><mi>i</mi></mrow></msub><mo>=</mo><mfrac><mrow><mi>œÄ</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mtext mathvariant="bold">ùêÄ</mtext><mi>i</mi></msub><mo>;</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>f</mi><mrow><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêÄ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ùêó</mi><mi>i</mi></msub><mo>;</mo><mover><mi>ùõâ</mi><mo accent="true">ÃÇ</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>=</mo><mfrac><mrow><munderover><mo>‚àè</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>i</mi></msub></munderover><msup><mi>Œ±</mi><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></msup><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mn>1</mn><mo>‚àí</mo><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow></msup></mrow><mrow><mo>‚à´</mo><munderover><mo>‚àè</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>i</mi></msub></munderover><msubsup><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></msubsup><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mn>1</mn><mo>‚àí</mo><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow></msup><msub><mi>f</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>b</mi><mi>i</mi></msub><mo>;</mo><msub><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>b</mi><mi>i</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">
w_{1i} = \frac{\pi(\textbf{A}_i ; \alpha)}{f_{\mathbf{A}_i | \mathbf{X}_i}(\mathbf{A}_i | \mathbf{X}_i; \hat{\boldsymbol{\theta}})} = \frac{\prod_{j=1}^{n_i} \alpha^{A_{ij}} (1 - \alpha)^{1 - A_{ij}}}{ \int \prod_{j=1}^{n_i} h_{ij}^{A_{ij}} (1 - h_{ij})^{1 - A_{ij}}  f_b (b_i ; \hat{\theta}_s) db_i  } </annotation></semantics></math></p>
<p>or equivalently,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mn>2</mn><mi>i</mi></mrow></msub><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">{</mo><mo>‚à´</mo><munderover><mo>‚àè</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>i</mi></msub></munderover><msup><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>Œ±</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></msup><msup><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mn>1</mn><mo>‚àí</mo><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><mrow><mn>1</mn><mo>‚àí</mo><mi>Œ±</mi></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mn>1</mn><mo>‚àí</mo><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow></msup><msub><mi>f</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>b</mi><mi>i</mi></msub><mo>;</mo><msub><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>b</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">}</mo></mrow><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">
w_{2i} = \left\{ \int \prod_{j=1}^{n_i} \left(\frac{h_{ij}}{\alpha}\right)^{A_{ij}} \left(\frac{1 - h_{ij}}{1 - \alpha}\right)^{1 - A_{ij}}  f_b (b_i ; \hat{\theta}_s) db_i  \right\}^{-1} </annotation></semantics></math></p>
<p>or,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mn>3</mn><mi>i</mi></mrow></msub><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">{</mo><mo>‚à´</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><munderover><mo>‚àë</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>i</mi></msub></munderover><mrow><mo stretchy="true" form="prefix">{</mo><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>Œ±</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><msub><mi>A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mn>1</mn><mo>‚àí</mo><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><mrow><mn>1</mn><mo>‚àí</mo><mi>Œ±</mi></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">}</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><msub><mi>f</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>b</mi><mi>i</mi></msub><mo>;</mo><msub><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>b</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">}</mo></mrow><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mi>.</mi></mrow><annotation encoding="application/x-tex">
w_{3i} = \left\{ \int \exp\left[ \sum_{j=1}^{n_i} \left\{ A_{ij} \log \left( \frac{h_{ij}}{\alpha}\right) + (1 - A_{ij})\log \left(\frac{1 - h_{ij}}{1 - \alpha}\right) \right\} \right] f_b (b_i ; \hat{\theta}_s) db_i \right\}^{-1}. 
</annotation></semantics></math></p>
<p>While mathematically equivalent, these weights may be computationally
dissimilar. In the case of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>1</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{1i}</annotation></semantics></math>,
the product term within the integral entails multiplying probabilities
and thus will tend to 0 as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>i</mi></msub><annotation encoding="application/x-tex">n_i</annotation></semantics></math>
increases, causing the denominator of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>1</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{1i}</annotation></semantics></math>
to get arbitrarily large. In contrast, the product term in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>2</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{2i}</annotation></semantics></math>
entails multiplying values which may be less than or greater than 1 and
thus tends to be less susceptible to numerical instability. Summing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>/</mi><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(h_{ij}/\alpha)</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>Œ±</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\log(1 - h_{ij})/(1 - \alpha))</annotation></semantics></math>
and then exponentiating the result may provide greater numerical
stability. Internally, <code>inferference</code> uses
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>3</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{3i}</annotation></semantics></math>.</p>
<p>When group sizes are small, the differences between these weights
tend to be infinitesimal, but as group sizes grow the differences become
important. To be specific, consider the code below comparing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>1</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{1i}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>2</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{2i}</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>3</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{3i}</annotation></semantics></math>
for increasing group sizes where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ±</mi><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.5</annotation></semantics></math>,
all units are treated, there is no random effect, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>h</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">h_{ij}</annotation></semantics></math>
is fixed at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0.5</mn><annotation encoding="application/x-tex">0.5</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="sc">&gt;</span> compare_weights <span class="ot">&lt;-</span> <span class="cf">function</span>(n, <span class="at">alpha =</span> .<span class="dv">5</span>, <span class="at">h =</span> .<span class="dv">5</span>){</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="sc">+</span>   pi  <span class="ot">&lt;-</span> <span class="fu">rep</span>(alpha, n)</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="sc">+</span>   PrA <span class="ot">&lt;-</span> <span class="fu">rep</span>(h, n)</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="sc">+</span>   <span class="fu">c</span>(<span class="at">w1 =</span> <span class="fu">prod</span>(pi)<span class="sc">/</span><span class="fu">prod</span>(PrA),</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="sc">+</span>     <span class="at">w2 =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">prod</span>(PrA<span class="sc">/</span>pi),</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="sc">+</span>     <span class="at">w3 =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">exp</span>(<span class="fu">sum</span>(<span class="fu">log</span>(PrA<span class="sc">/</span>pi))))  </span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a><span class="sc">+</span> }</span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a><span class="sc">&gt;</span> n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">1074</span>, <span class="dv">1075</span>, <span class="dv">10000</span>)</span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">cbind</span>(n, <span class="fu">t</span>(<span class="fu">sapply</span>(n, <span class="at">FUN =</span> compare_weights)))</span></code></pre></div>
<pre><code><span><span class="co">##          n  w1 w2 w3</span></span>
<span><span class="co">## [1,]    50   1  1  1</span></span>
<span><span class="co">## [2,]   100   1  1  1</span></span>
<span><span class="co">## [3,]   500   1  1  1</span></span>
<span><span class="co">## [4,]  1074   1  1  1</span></span>
<span><span class="co">## [5,]  1075 NaN  1  1</span></span>
<span><span class="co">## [6,] 10000 NaN  1  1</span></span></code></pre>
<p>For group sizes up to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1074</mn><annotation encoding="application/x-tex">1074</annotation></semantics></math>
there is no difference, but when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
reaches
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1075</mn><annotation encoding="application/x-tex">1075</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>1</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{1i}</annotation></semantics></math>
returns <code>NaN</code> while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>2</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{2i}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>3</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{3i}</annotation></semantics></math>
correctly return 1.</p>
<p><span class="citation">Perez-Heydrich et al. (2014)</span> used
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>1</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{1i}</annotation></semantics></math>
to calculate weights, but 15 groups in their analysis had over 1000
subjects. These groups had missing values for weights for all the values
of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ±</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
considered and were excluded from computing the average IPW estimate.
Rather than computing the average IPW across 700 groups, they
inadvertently took the average across 685 groups. Correcting the
estimates by using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>2</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{2i}</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mn>3</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">w_{3i}</annotation></semantics></math>
did not alter the conclusions in this case, but analysts should be aware
of this issue when dealing with large groups.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-ali2005" class="csl-entry">
Ali, Mohammad, Michael Emch, Lorenz von Seidlein, Mohammad Yunus, David
A. Sack, Malla Roa, Jan Holmgren, and John D. Clemens. 2005. <span>‚ÄúHerd
Immunity Conferred by Killed Oral Cholera Vaccines in Bangladesh: A
Reanalysis.‚Äù</span> <em>The Lancet</em> 366 (9479): 44‚Äì49.
</div>
<div id="ref-lme4" class="csl-entry">
Bates, D., M. Maechler, B. Bolker, and S. Walker. 2014. <span>‚ÄúLme4:
Linear Mixed-Effects Models Using Eigen and S4. R Package Version
1.1-7.‚Äù</span> <a href="https://CRAN.R-project.org/package=lme4" class="external-link">https://CRAN.R-project.org/package=lme4</a>.
</div>
<div id="ref-numDeriv2012" class="csl-entry">
Gilbert, Paul, and Ravi Varadhan. 2012. <span>‚ÄúnumDeriv: Accurate
Numerical Derivatives. R Package Version 2012.9-1.‚Äù</span> <a href="https://CRAN.R-project.org/package=numDeriv" class="external-link">https://CRAN.R-project.org/package=numDeriv</a>.
</div>
<div id="ref-nickerson2008" class="csl-entry">
Nickerson, David W. 2008. <span>‚ÄúIs Voting Contagious? Evidence from Two
Field Experiments.‚Äù</span> <em>American Political Science Review</em>
102 (1): 49‚Äì57.
</div>
<div id="ref-carolina2014" class="csl-entry">
Perez-Heydrich, Carolina, Michael G. Hudgens, M. Elizabeth Halloran,
John D. Clemens, Mohammed Ali, and Michael E. Emch. 2014.
<em>Biometrics</em> 70 (3): 731‚Äì41.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Bradley Saul.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

      </footer>
</div>






  </body>
</html>
